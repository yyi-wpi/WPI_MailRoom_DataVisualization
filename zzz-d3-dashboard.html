<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Package Analytics Dashboard</title>
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <!-- D3-Sankey for Sankey diagrams -->
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Marked for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        body {
            background-color: #111;
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .app-header {
            padding: 20px 0;
        }
        
        .tab-content {
            padding: 20px 0;
        }
        
        .card {
            background-color: #222;
            border: none;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .card-body {
            padding: 20px;
        }
        
        .nav-tabs .nav-link {
            color: #aaa;
            border: none;
            padding: 10px 20px;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        
        .nav-tabs .nav-link:hover {
            background-color: #333;
            color: #fff;
        }
        
        .nav-tabs .nav-link.active {
            background-color: #222;
            color: #FFD700;
            border: none;
        }
        
        .dashboard-stats .card {
            padding: 15px;
            text-align: center;
            transition: transform 0.3s;
        }
        
        .dashboard-stats .card:hover {
            transform: translateY(-5px);
        }
        
        /* County Map Styles (from heatmap_filtering.html) */
        .county {
            stroke: #bbb;
            stroke-width: 0.3px;
        }
        
        .state {
            stroke: #333;
            stroke-width: 2px;
        }
        
        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            border: 1px solid #444;
            padding: 10px;
            pointer-events: none;
            font-family: sans-serif;
            color: white;
            border-radius: 5px;
            z-index: 1000;
        }
        
        /* Specific visualization containers */
        .viz-container {
            width: 100%;
            height: 500px;
        }
        
        /* Legend style */
        .legend-container {
            margin-top: 20px;
            text-align: center;
        }
        
        /* Bar chart styles */
        .bar {
            cursor: pointer;
        }

        .markdown-body {
            color: #eee;
        }

        .axis text {
            fill: #ddd;
        }

        .axis path,
        .axis line {
            stroke: #555;
        }

        .axis-title {
            fill: #ddd;
        }

        #barChart .axis text {
            fill: white;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row app-header">
            <div class="col-12 text-center">
                <h1 style="color: #FFD700;">üì¶ Ultimate Package Tracking Dashboard üöÄ</h1>
                <hr style="color: #444;">
            </div>
        </div>
        
        <!-- Stats Cards -->
        <div class="row dashboard-stats mb-4">
            <div class="col-md-4">
                <div class="card">
                    <h4 id="total-packages" style="color: #FF4500;">üì¶ Total Packages: Loading...</h4>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <h4 id="top-carrier" style="color: #32CD32;">üöö Top Carrier: Loading...</h4>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <h4 id="avg-time" style="color: #1E90FF;">‚è≥ Avg. Processing Time: Loading...</h4>
                </div>
            </div>
        </div>
        
        <!-- Tabs -->
        <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="package-flow-tab" data-bs-toggle="tab" data-bs-target="#package-flow" type="button" role="tab">üì¶ Package Flow</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="county-map-tab" data-bs-toggle="tab" data-bs-target="#county-map" type="button" role="tab">üåç County Map</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="statistical-tab" data-bs-toggle="tab" data-bs-target="#statistical" type="button" role="tab">üìà Statistical Insights</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="additional-tab" data-bs-toggle="tab" data-bs-target="#additional" type="button" role="tab">üìä Additional Insights</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="heatmap-tab" data-bs-toggle="tab" data-bs-target="#heatmap" type="button" role="tab">üî• Heatmap & Trends</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="readme-tab" data-bs-toggle="tab" data-bs-target="#readme" type="button" role="tab">üìÑ README</button>
            </li>
        </ul>
        
        <!-- Tab content -->
        <div class="tab-content" id="dashboardTabsContent">
            <!-- Package Flow Tab (Sankey Diagram) -->
            <div class="tab-pane fade show active" id="package-flow" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h3 class="text-center mb-4">üìä Real-time Package Flow</h3>
                        <div id="sankey-container" class="viz-container"></div>
                    </div>
                </div>
            </div>
            
            <!-- County Map Tab -->
            <div class="tab-pane fade" id="county-map" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h3 class="text-center">üåç County Map</h3>
                        <div class="subtitle text-center text-muted mb-3">Click on a carrier to filter the map</div>
                        <div id="carrier-chart-container" class="d-flex justify-content-center mb-4">
                            <svg id="barChart" width="800" height="200"></svg>
                        </div>
                        <div id="map-container" class="d-flex justify-content-center">
                            <svg id="map" width="960" height="600">
                                <g id="gMap"></g>
                            </svg>
                        </div>
                        <div class="legend-container">
                            <svg id="legend" width="500" height="60"></svg>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Statistical Insights Tab -->
            <div class="tab-pane fade" id="statistical" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h3 class="text-center mb-4">üìä Carrier Distribution</h3>
                                <div id="carrier-bar-container" class="viz-container"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h3 class="text-center mb-4">üì¶ Package Processing Histogram</h3>
                                <div id="histogram-container" class="viz-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Additional Insights Tab -->
            <div class="tab-pane fade" id="additional" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h3 class="text-center mb-4">üìä Processing Time Over Time</h3>
                                <div id="line-chart-container" class="viz-container"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h3 class="text-center mb-4">üì¶ Package Volume by Carrier</h3>
                                <div id="pie-chart-container" class="viz-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Heatmap Tab -->
            <div class="tab-pane fade" id="heatmap" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h3 class="text-center mb-4">‚è∞ Package Pickup Heatmap</h3>
                        <div id="pickup-heatmap-container" class="viz-container"></div>
                    </div>
                </div>
            </div>
            
            <!-- README Tab -->
            <div class="tab-pane fade" id="readme" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h3 class="text-center mb-4">üìÑ Project Documentation</h3>
                        <div id="readme-container" class="markdown-body mt-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- D3 Script -->
    <script>
        // Define tooltip divs
        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);
        
        // Add loading indicator
        function showLoading(selector, message = "Loading data...") {
            d3.select(selector).html(`
                <div class="d-flex justify-content-center align-items-center" style="height: 200px;">
                    <div class="text-center">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>${message}</p>
                    </div>
                </div>
            `);
        }
        
        // Show error message
        function showError(selector, message) {
            d3.select(selector).html(`
                <div class="alert alert-danger m-3" role="alert">
                    <h4 class="alert-heading">Error Loading Data</h4>
                    <p>${message}</p>
                    <hr>
                    <p class="mb-0">Please make sure the CSV file is in the correct location and try again.</p>
                </div>
            `);
        }
        
        // Add loading indicators to visualization containers
        showLoading("#sankey-container");
        showLoading("#carrier-bar-container");
        showLoading("#histogram-container");
        showLoading("#line-chart-container");
        showLoading("#pie-chart-container");
        showLoading("#pickup-heatmap-container");
            
        // Load data using FileReader API when available
        async function loadData() {
            try {
                // Try to load data from the window.fs if available (when running in Claude)
                if (typeof window.fs !== 'undefined' && window.fs.readFile) {
                    console.log("Using window.fs to read the CSV file");
                    const response = await window.fs.readFile('Cleaned_Package_Data_County_FIPS.csv');
                    const csvText = new TextDecoder().decode(response);
                    
                    // Parse CSV
                    const data = Papa.parse(csvText, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true
                    }).data;
                    
                    initializeDashboard(data);
                } else {
                    // Fall back to d3.csv for standard web environments
                    console.log("Using d3.csv to read the CSV file");
                    d3.csv("Cleaned_Package_Data_County_FIPS.csv").then(function(data) {
                        initializeDashboard(data);
                    }).catch(function(error) {
                        console.error("Error loading CSV with d3:", error);
                        showError("#sankey-container", "Failed to load the CSV file.");
                    });
                }
            } catch (error) {
                console.error("Error loading data:", error);
                showError("#sankey-container", "Failed to load the CSV file: " + error.message);
            }
        }
        
        // Initialize all visualizations after data is loaded
        function initializeDashboard(data) {
            console.log("Data loaded successfully. Initializing dashboard...");
            console.log("Number of records:", data.length);
            
            if (!data || data.length === 0) {
                showError("#sankey-container", "The CSV file was loaded but contains no valid data.");
                return;
            }
            
            // Process data
            const processedData = processData(data);
            console.log("Data processed. Records after processing:", processedData.length);
            
            // Update statistics cards
            updateStatistics(processedData);
            
            // Create all visualizations
            createSankeyDiagram(processedData);
            createCarrierBar(processedData);
            createHistogram(processedData);
            createLineChart(processedData);
            createPieChart(processedData);
            createPickupHeatmap(processedData);
            
            // Initialize county map when tab is activated
            d3.select('#county-map-tab').on('click', function() {
                // Only initialize if it hasn't been created yet
                if (!d3.select("#gMap").selectAll("*").size()) {
                    initializeCountyMap(data);
                }
            });
        }
        
        // Start loading data
        document.addEventListener('DOMContentLoaded', loadData);
        });
        
        // County Map Functions (from heatmap_filtering.html)
        function initializeCountyMap(fullData) {
            // Define carrier colors
            const carrierColors = {
                "UPS": "#8B4513",      // Brown for UPS
                "USPS": "#1E90FF",     // Blue for USPS
                "FedEx": "#800080",    // Purple for FedEx
                "Amazon": "#FF8C00",   // Orange for Amazon
                "DHL": "#FFD700",      // Gold/Yellow for DHL
                "Other": "#2E8B57"     // Sea Green for any other carrier
            };
            
            // Default color for 'Other' carriers
            const defaultCarrierColor = "#2E8B57";
            
            // Current filter state
            let currentFilter = null;
            
            // Filter out rows with empty County FIPS
            const filteredData = fullData.filter(d => d["County FIPS"] && d["County FIPS"].trim() !== "");
            
            // Process data for map
            const processMapData = (data) => {
                let countyCounts = d3.rollup(data, v => v.length, d => d["County FIPS"]);
                return countyCounts;
            };
            
            // Process data for carrier chart
            const processCarrierData = (data) => {
                let carrierCounts = d3.rollup(data, v => v.length, d => d["Carrier"] || "Unknown");
                
                // Convert to array for chart
                let carrierData = Array.from(carrierCounts, ([key, value]) => ({
                    carrier: key === "Unknown" ? "Other" : key,
                    count: value
                }));
                
                // Sort by count (descending)
                carrierData.sort((a, b) => b.count - a.count);
                
                return carrierData;
            };
            
            // Load US map data
            d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/counties-albers-10m.json").then(us => {
                const counties = topojson.feature(us, us.objects.counties);
                const states = topojson.mesh(us, us.objects.states);
                
                // Store the full dataset
                let filteredMapData = filteredData;
                
                // Create maps to store county information
                const countyInfo = new Map();
                filteredData.forEach(d => {
                    countyInfo.set(d["County FIPS"], {
                        county: d["Origin County"],
                        state: d["Origin State"]
                    });
                });
                
                // Initialize map with all data
                let countyCounts = processMapData(filteredMapData);
                const maxCount = d3.max([...countyCounts.values()]) || 1;
                
                // Create color scale for map
                const colorScale = d3.scaleLog()
                    .domain([1, maxCount])
                    .range(["#ffe6e6", "#ff0000"])
                    .clamp(true);
                
                const getColor = (count) => count > 0 ? colorScale(count) : "#222";
                
                // Get SVG and set up zoom
                const svg = d3.select("#map");
                const gMap = svg.select("#gMap");
                
                // Create zoom behavior
                const zoom = d3.zoom()
                    .scaleExtent([1, 100])
                    .on("zoom", (event) => {
                        gMap.attr("transform", event.transform);
                        
                        const currentScale = event.transform.k;
                        const countyStrokeWidth = Math.max(0.3 / currentScale, 0.05);
                        const stateStrokeWidth = Math.max(2 / currentScale, 0.2);
                        
                        d3.selectAll(".county").style("stroke-width", countyStrokeWidth + "px");
                        d3.selectAll(".state").style("stroke-width", stateStrokeWidth + "px");
                    });
                
                svg.call(zoom);
                
                // Create map path
                const path = d3.geoPath();
                
                // Create county features
                const countyFeatures = gMap.append("g")
                    .selectAll("path")
                    .data(counties.features)
                    .enter().append("path")
                    .attr("class", "county")
                    .attr("d", path)
                    .attr("fill", d => getColor(countyCounts.get(d.id) || 0))
                    .on("mouseover", function(event, d) {
                        const currentScale = d3.zoomTransform(svg.node()).k; 
                        const hoverStrokeWidth = Math.max(1 / currentScale, 0.2);
                        
                        const countyFIPS = d.id;
                        const count = countyCounts.get(countyFIPS) || 0;
                        const info = countyInfo.get(countyFIPS) || { county: "Unknown", state: "Unknown" };
                        
                        if (count === 0) return;
                        
                        tooltip.transition().duration(200).style("opacity", 1);
                        tooltip.html(`<strong>${info.county} County, ${info.state}</strong><br>Packages: ${count}`)
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px");
                        
                        d3.select(this)
                            .style("stroke", "white")
                            .style("stroke-width", hoverStrokeWidth + "px")
                            .raise();
                    })
                    .on("mouseout", function() {
                        const currentScale = d3.zoomTransform(svg.node()).k; 
                        const normalStrokeWidth = Math.max(0.3 / currentScale, 0.05);
                        
                        tooltip.transition().duration(500).style("opacity", 0);
                        
                        d3.select(this)
                            .style("stroke", "#bbb")
                            .style("stroke-width", normalStrokeWidth + "px");
                    });
                
                // Create state boundaries
                gMap.append("path")
                    .datum(states)
                    .attr("class", "state")
                    .attr("d", path)
                    .attr("fill", "none");
                
                // Create map legend
                createMapLegend(maxCount, colorScale);
                
                // Process carrier data and create bar chart
                const carrierData = processCarrierData(filteredData);
                createCarrierChart(carrierData);
                
                // Function to create map legend
                function createMapLegend(maxCount, colorScale) {
                    const legendSvg = d3.select("#legend");
                    legendSvg.selectAll("*").remove();
                    
                    const legendWidth = 300, legendHeight = 20, legendMargin = { top: 20, right: 20, bottom: 20, left: 20 };
                    
                    const logScale = d3.scaleLog()
                        .domain([1, maxCount])
                        .range([0, legendWidth]);
                    
                    const defs = legendSvg.append("defs");
                    const gradient = defs.append("linearGradient")
                        .attr("id", "legend-gradient")
                        .attr("x1", "0%").attr("x2", "100%")
                        .attr("y1", "0%").attr("y2", "0%");
                    
                    const numStops = 10;
                    for (let i = 0; i <= numStops; i++) {
                        const t = i / numStops;
                        const logValue = Math.pow(maxCount, t);
                        gradient.append("stop")
                            .attr("offset", `${t * 100}%`)
                            .attr("stop-color", colorScale(logValue));
                    }
                    
                    const legend = legendSvg.append("g")
                        .attr("transform", `translate(${(500 - legendWidth) / 2}, ${legendMargin.top})`);
                    
                    legend.append("rect")
                        .attr("width", legendWidth)
                        .attr("height", legendHeight)
                        .style("fill", "url(#legend-gradient)")
                        .style("stroke", "#ccc")
                        .style("stroke-width", "1px");
                    
                    legendSvg.append("text")
                        .attr("x", 500 / 2)
                        .attr("y", 15)
                        .style("text-anchor", "middle")
                        .style("font-weight", "bold")
                        .style("fill", "white")
                        .text(currentFilter ? `Packages from County (${currentFilter} Only)` : "Packages from County (Log Scale)");
                    
                    const tickValues = [];
                    let baseTick = 1;
                    while (baseTick <= maxCount) {
                        tickValues.push(baseTick);
                        baseTick *= 10;
                    }
                    
                    if (maxCount < 10) tickValues.splice(1, 0, 2, 5);
                    
                    tickValues.forEach(value => {
                        if (value <= maxCount && value > 1) {
                            const xPos = logScale(value);
                            legend.append("line")
                                .attr("x1", xPos).attr("x2", xPos)
                                .attr("y1", legendHeight).attr("y2", legendHeight + 5)
                                .style("stroke", "white").style("stroke-width", "1px");
                            
                            legend.append("text")
                                .attr("x", xPos)
                                .attr("y", legendHeight + 15)
                                .style("text-anchor", "middle")
                                .style("fill", "white")
                                .text(value);
                        }
                    });
                    
                    // Add min and max labels
                    legend.append("text")
                        .attr("x", 0)
                        .attr("y", legendHeight + 15)
                        .style("text-anchor", "middle")
                        .style("fill", "white")
                        .text("1");
                    
                    legend.append("line")
                        .attr("x1", 0)
                        .attr("x2", 0)
                        .attr("y1", legendHeight)
                        .attr("y2", legendHeight + 5)
                        .style("stroke", "white")
                        .style("stroke-width", "1px");
                    
                    legend.append("text")
                        .attr("x", legendWidth)
                        .attr("y", legendHeight + 15)
                        .style("text-anchor", "middle")
                        .style("fill", "white")
                        .text(maxCount);
                    
                    legend.append("line")
                        .attr("x1", legendWidth)
                        .attr("x2", legendWidth)
                        .attr("y1", legendHeight)
                        .attr("y2", legendHeight + 5)
                        .style("stroke", "white")
                        .style("stroke-width", "1px");
                }
                
                // Function to create carrier bar chart
                function createCarrierChart(data) {
                    const barSvg = d3.select("#barChart");
                    barSvg.selectAll("*").remove();
                    
                    const margin = { top: 30, right: 20, bottom: 50, left: 60 };
                    const barWidth = 800 - margin.left - margin.right;
                    const barHeight = 200 - margin.top - margin.bottom;
                    
                    const g = barSvg.append("g")
                        .attr("transform", `translate(${margin.left},${margin.top})`);
                    
                    // Set up scales
                    const x = d3.scaleBand()
                        .domain(data.map(d => d.carrier))
                        .range([0, barWidth])
                        .padding(0.3);
                    
                    const maxBarValue = d3.max(data, d => d.count) || 1;
                    
                    const y = d3.scaleLinear()
                        .domain([0, maxBarValue])
                        .nice()
                        .range([barHeight, 0]);
                    
                    // Add x axis
                    g.append("g")
                        .attr("transform", `translate(0,${barHeight})`)
                        .call(d3.axisBottom(x))
                        .selectAll("text")
                        .attr("y", 10)
                        .attr("x", -5)
                        .attr("text-anchor", "end")
                        .attr("transform", "rotate(-45)")
                        .style("fill", "white");
                    
                    // Add y axis
                    g.append("g")
                        .call(d3.axisLeft(y).ticks(5))
                        .selectAll("text")
                        .style("fill", "white");
                    
                    // Add y axis label
                    g.append("text")
                        .attr("transform", "rotate(-90)")
                        .attr("y", -40)
                        .attr("x", -barHeight / 2)
                        .attr("text-anchor", "middle")
                        .style("fill", "white")
                        .text("Number of Packages");
                    
                    // Add bars
                    g.selectAll(".bar")
                        .data(data)
                        .enter().append("rect")
                        .attr("class", "bar")
                        .attr("x", d => x(d.carrier))
                        .attr("y", d => y(d.count))
                        .attr("width", x.bandwidth())
                        .attr("height", d => barHeight - y(d.count))
                        .attr("fill", d => carrierColors[d.carrier] || defaultCarrierColor)
                        .attr("stroke", "#333")
                        .attr("stroke-width", "1px")
                        .style("cursor", "pointer")
                        .on("mouseover", function(event, d) {
                            d3.select(this).attr("fill", d3.color(carrierColors[d.carrier] || defaultCarrierColor).brighter(0.5));
                            
                            tooltip.transition().duration(200).style("opacity", 1);
                            tooltip.html(`<strong>${d.carrier}</strong><br>${d.count.toLocaleString()} packages`)
                                .style("left", (event.pageX + 10) + "px")
                                .style("top", (event.pageY - 28) + "px");
                        })
                        .on("mouseout", function(event, d) {
                            d3.select(this).attr("fill", carrierColors[d.carrier] || defaultCarrierColor);
                            tooltip.transition().duration(500).style("opacity", 0);
                        })
                        .on("click", function(event, d) {
                            filterMapByCarrier(d.carrier);
                        });
                }
                
                // Function to filter map by carrier
                function filterMapByCarrier(carrier) {
                    // Update filter state
                    if (currentFilter === carrier) {
                        // If clicking the same carrier again, reset filter
                        currentFilter = null;
                        filteredMapData = filteredData;
                    } else {
                        // Set new filter
                        currentFilter = carrier;
                        filteredMapData = filteredData.filter(d => 
                            carrier === "Other" 
                                ? !d["Carrier"] || d["Carrier"] === "Unknown" || !carrierColors[d["Carrier"]]
                                : d["Carrier"] === carrier
                        );
                    }
                    
                    // Update map with filtered data
                    updateMap();
                    
                    // Update bar chart highlighting
                    d3.selectAll(".bar")
                        .attr("opacity", d => currentFilter && d.carrier !== currentFilter ? 0.5 : 1)
                        .attr("stroke-width", d => d.carrier === currentFilter ? "2px" : "1px");
                    
                    // Update subtitle
                    d3.select(".subtitle")
                        .text(currentFilter 
                            ? `Showing packages from ${currentFilter} carrier - Click on ${currentFilter} again to reset` 
                            : "Click on a carrier to filter the map");
                }
                
                // Function to update map with filtered data
                function updateMap() {
                    // Recalculate county counts
                    countyCounts = processMapData(filteredMapData);
                    const newMaxCount = d3.max([...countyCounts.values()]) || maxCount;
                    
                    // Update color scale with new max count
                    const newColorScale = d3.scaleLog()
                        .domain([1, newMaxCount])
                        .range(["#ffe6e6", "#ff0000"])
                        .clamp(true);
                    
                    // Update county colors
                    countyFeatures.transition().duration(500)
                        .attr("fill", d => {
                            const count = countyCounts.get(d.id) || 0;
                            return count > 0 ? newColorScale(count) : "#222";
                        });
                    
                    // Clear and recreate legend
                    createMapLegend(newMaxCount, newColorScale);
                }
            });
        }
        });
        
        // Load README (fallback to a default message if not available)
        d3.text("README.md").then(function(text) {
            d3.select("#readme-container").html(marked.parse(text));
        }).catch(function() {
            d3.select("#readme-container").html(`
                <h4>Package Analytics Dashboard</h4>
                <p>This dashboard provides comprehensive visualization of package tracking data.</p>
                <p>Features include:</p>
                <ul>
                    <li>Sankey diagram showing package flow</li>
                    <li>Interactive county map with carrier filtering</li>
                    <li>Statistical insights with distributions</li>
                    <li>Time-based visualizations</li>
                    <li>Package pickup heatmap by day and hour</li>
                </ul>
                <p>For more information, please refer to the documentation.</p>
            `);
        });
        
        // Process data function
        function processData(data) {
            console.log("Processing data...");
            console.log("Sample record:", data[0]);
            
            // Try to detect date format from the first valid record
            let dateFormat = detectDateFormat(data);
            console.log("Detected date format:", dateFormat);
            
            // Parse dates
            data.forEach(d => {
                // Parse date strings to Date objects
                ["Routed Date Time", "Stored Date Time", "Delivered Date Time"].forEach(col => {
                    if (d[col]) {
                        try {
                            if (dateFormat === "mm/dd/yyyy") {
                                const parts = d[col].split(/[/ :]/);
                                // Month/Day/Year Hour:Minute format
                                if (parts.length >= 5) {
                                    const month = parseInt(parts[0]) - 1; // 0-based months
                                    const day = parseInt(parts[1]);
                                    const year = parseInt(parts[2]);
                                    const hour = parseInt(parts[3]);
                                    const minute = parseInt(parts[4]);
                                    d[col] = new Date(year, month, day, hour, minute);
                                } else {
                                    d[col] = null;
                                }
                            } else {
                                // Try standard Date parsing as fallback
                                d[col] = new Date(d[col]);
                                if (isNaN(d[col].getTime())) {
                                    d[col] = null;
                                }
                            }
                        } catch (e) {
                            console.warn(`Error parsing date ${d[col]}:`, e);
                            d[col] = null;
                        }
                    } else {
                        d[col] = null;
                    }
                });
                
                // Use existing processing time if available
                if (d["Processing Time (Hours)"] && !isNaN(parseFloat(d["Processing Time (Hours)"]))) {
                    d["Total Processing Time"] = parseFloat(d["Processing Time (Hours)"]);
                }
                // Otherwise calculate processing times if dates are valid
                else {
                    if (d["Routed Date Time"] && d["Stored Date Time"]) {
                        d["Routed ‚Üí Stored"] = (d["Stored Date Time"] - d["Routed Date Time"]) / (1000 * 60 * 60); // Hours
                    }
                    
                    if (d["Stored Date Time"] && d["Delivered Date Time"]) {
                        d["Stored ‚Üí Delivered"] = (d["Delivered Date Time"] - d["Stored Date Time"]) / (1000 * 60 * 60); // Hours
                    }
                    
                    if (d["Routed Date Time"] && d["Delivered Date Time"]) {
                        d["Total Processing Time"] = (d["Delivered Date Time"] - d["Routed Date Time"]) / (1000 * 60 * 60); // Hours
                    }
                }
            });
            
            // Function to detect date format from the first valid record
            function detectDateFormat(data) {
                for (let i = 0; i < Math.min(data.length, 10); i++) {
                    const record = data[i];
                    for (const field of ["Routed Date Time", "Stored Date Time", "Delivered Date Time"]) {
                        if (record[field]) {
                            const dateStr = record[field];
                            // Check if it's in m/d/y format
                            if (/^\d{1,2}\/\d{1,2}\/\d{4}\s\d{1,2}:\d{1,2}/.test(dateStr)) {
                                return "mm/dd/yyyy";
                            }
                        }
                    }
                }
                return "unknown";
            }
            
            // Filter out entries with missing required dates
            const filteredData = data.filter(d => d["Routed Date Time"] && d["Delivered Date Time"]);
            
            return filteredData;
        }
        
        // Function to safely convert string to float
        function safeParseFloat(value) {
            if (value === null || value === undefined || value === "") return null;
            const parsed = parseFloat(value);
            return isNaN(parsed) ? null : parsed;
        }
        }
        
        // Update statistics cards
        function updateStatistics(data) {
            // Total packages
            d3.select("#total-packages").text(`üì¶ Total Packages: ${data.length.toLocaleString()}`);
            
            // Top carrier
            const carrierCounts = d3.rollup(data, v => v.length, d => d.Carrier || "Unknown");
            const topCarrierArray = [...carrierCounts].sort((a, b) => b[1] - a[1]);
            const topCarrier = topCarrierArray.length > 0 ? topCarrierArray[0][0] : "Unknown";
            d3.select("#top-carrier").text(`üöö Top Carrier: ${topCarrier}`);
            
            // Average processing time
            const validTimes = data.filter(d => d["Total Processing Time"] && !isNaN(d["Total Processing Time"]));
            const avgTime = validTimes.length > 0 ? 
                d3.mean(validTimes, d => d["Total Processing Time"]) : 0;
            d3.select("#avg-time").text(`‚è≥ Avg. Processing Time: ${avgTime.toFixed(2)} Hours`);
        }
        
        // Create Sankey Diagram (converted from Python)
        function createSankeyDiagram(data) {
            // Clear loading indicator
            d3.select("#sankey-container").html("");
            
            const width = document.getElementById('sankey-container').offsetWidth;
            const height = 500;
            
            // Prepare data for Sankey
            const nodes = [
                { name: "üì¶ Arrived" },
                { name: "üìç Sorting" },
                { name: "üì¶ Storage" },
                { name: "üöÄ Out for Delivery" },
                { name: "üè° Delivered" }
            ];
            
            // Calculate values based on data
            const routedToStoredAvg = d3.mean(data, d => d["Routed ‚Üí Stored"]) || 10;
            const storedToDeliveredAvg = d3.mean(data, d => d["Stored ‚Üí Delivered"]) || 15;
            
            const links = [
                { source: 0, target: 1, value: routedToStoredAvg * 100 },
                { source: 1, target: 2, value: storedToDeliveredAvg * 100 },
                { source: 1, target: 3, value: 4000 },
                { source: 2, target: 3, value: 3200 },
                { source: 2, target: 4, value: 1200 }
            ];
            
            // Set up Sankey diagram
            const sankey = d3.sankey()
                .nodeWidth(20)
                .nodePadding(10)
                .extent([[0, 5], [width - 10, height - 5]]);
            
            // Generate layout
            const sankeyData = sankey({
                nodes: nodes.map(d => Object.assign({}, d)),
                links: links.map(d => Object.assign({}, d))
            });
            
            // Create SVG
            const svg = d3.select("#sankey-container").append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g");
            
            // Add links
            const link = svg.append("g")
                .selectAll("path")
                .data(sankeyData.links)
                .join("path")
                .attr("d", d3.sankeyLinkHorizontal())
                .attr("stroke-width", d => Math.max(1, d.width))
                .attr("stroke", d => {
                    // Different colors for different paths
                    const colors = ["#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b"];
                    return colors[d.index % colors.length];
                })
                .style("fill", "none")
                .style("stroke-opacity", 0.5)
                .on("mouseover", function(event, d) {
                    d3.select(this).style("stroke-opacity", 0.8);
                    tooltip.transition().duration(200).style("opacity", 0.9);
                    tooltip.html(`${d.source.name} ‚Üí ${d.target.name}<br>Value: ${d.value.toFixed(0)}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this).style("stroke-opacity", 0.5);
                    tooltip.transition().duration(500).style("opacity", 0);
                });
            
            // Add nodes
            const node = svg.append("g")
                .selectAll("rect")
                .data(sankeyData.nodes)
                .join("rect")
                .attr("x", d => d.x0)
                .attr("y", d => d.y0)
                .attr("height", d => d.y1 - d.y0)
                .attr("width", d => d.x1 - d.x0)
                .attr("fill", (d, i) => d3.schemeCategory10[i % 10])
                .on("mouseover", function(event, d) {
                    tooltip.transition().duration(200).style("opacity", 0.9);
                    tooltip.html(`${d.name}<br>Value: ${d.value.toFixed(0)}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.transition().duration(500).style("opacity", 0);
                });
            
            // Add labels
            svg.append("g")
                .selectAll("text")
                .data(sankeyData.nodes)
                .join("text")
                .attr("x", d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
                .attr("y", d => (d.y1 + d.y0) / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", d => d.x0 < width / 2 ? "start" : "end")
                .text(d => d.name)
                .style("font-size", "12px")
                .style("fill", "white");
        }
        
        // Create Carrier Bar Chart (Statistical Insights tab)
        function createCarrierBar(data) {
            // Clear loading indicator
            d3.select("#carrier-bar-container").html("");
            
            const width = document.getElementById('carrier-bar-container').offsetWidth;
            const height = 400;
            const margin = { top: 30, right: 30, bottom: 70, left: 60 };
            
            // Process data
            const carrierCounts = d3.rollup(data, v => v.length, d => d.Carrier || "Unknown");
            const carrierData = Array.from(carrierCounts, ([key, value]) => ({ carrier: key, count: value }))
                .sort((a, b) => b.count - a.count);
            
            // Create SVG
            const svg = d3.select("#carrier-bar-container").append("svg")
                .attr("width", width)
                .attr("height", height);
            
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            const g = svg.append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);
            
            // X scale
            const x = d3.scaleBand()
                .domain(carrierData.map(d => d.carrier))
                .range([0, chartWidth])
                .padding(0.3);
            
            // Y scale
            const y = d3.scaleLinear()
                .domain([0, d3.max(carrierData, d => d.count)])
                .nice()
                .range([chartHeight, 0]);
            
            // Add X axis
            g.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(0, ${chartHeight})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end");
            
            // Add Y axis
            g.append("g")
                .attr("class", "axis")
                .call(d3.axisLeft(y));
            
            // Y axis label
            g.append("text")
                .attr("class", "axis-title")
                .attr("transform", "rotate(-90)")
                .attr("y", -40)
                .attr("x", -chartHeight / 2)
                .attr("text-anchor", "middle")
                .text("Number of Packages");
            
            // Bars
            g.selectAll(".bar")
                .data(carrierData)
                .join("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.carrier))
                .attr("y", d => y(d.count))
                .attr("width", x.bandwidth())
                .attr("height", d => chartHeight - y(d.count))
                .attr("fill", (d, i) => d3.schemeCategory10[i % 10])
                .on("mouseover", function(event, d) {
                    d3.select(this).attr("opacity", 0.8);
                    tooltip.transition().duration(200).style("opacity", 0.9);
                    tooltip.html(`${d.carrier}<br>${d.count.toLocaleString()} packages`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this).attr("opacity", 1);
                    tooltip.transition().duration(500).style("opacity", 0);
                });
        }
        
        // Create Histogram
        function createHistogram(data) {
            // Clear loading indicator
            d3.select("#histogram-container").html("");
            
            const width = document.getElementById('histogram-container').offsetWidth;
            const height = 400;
            const margin = { top: 30, right: 30, bottom: 40, left: 60 };
            
            // Filter out invalid data and extreme outliers (processing times > 200 hours)
            const filteredData = data.filter(d => d["Total Processing Time"] && 
                                               !isNaN(d["Total Processing Time"]) && 
                                               d["Total Processing Time"] < 200);
            
            // Create SVG
            const svg = d3.select("#histogram-container").append("svg")
                .attr("width", width)
                .attr("height", height);
            
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            const g = svg.append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);
            
            // X scale
            const x = d3.scaleLinear()
                .domain([0, d3.max(filteredData, d => d["Total Processing Time"])])
                .nice()
                .range([0, chartWidth]);
            
            // Bin the data
            const histogram = d3.histogram()
                .value(d => d["Total Processing Time"])
                .domain(x.domain())
                .thresholds(x.ticks(50));
            
            const bins = histogram(filteredData);
            
            // Y scale
            const y = d3.scaleLinear()
                .domain([0, d3.max(bins, d => d.length)])
                .nice()
                .range([chartHeight, 0]);
            
            // Add X axis
            g.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(0, ${chartHeight})`)
                .call(d3.axisBottom(x));
            
            // Add X axis label
            g.append("text")
                .attr("class", "axis-title")
                .attr("x", chartWidth / 2)
                .attr("y", chartHeight + 35)
                .attr("text-anchor", "middle")
                .text("Processing Time (Hours)");
            
            // Add Y axis
            g.append("g")
                .attr("class", "axis")
                .call(d3.axisLeft(y));
            
            // Y axis label
            g.append("text")
                .attr("class", "axis-title")
                .attr("transform", "rotate(-90)")
                .attr("y", -45)
                .attr("x", -chartHeight / 2)
                .attr("text-anchor", "middle")
                .text("Frequency");
            
            // Add bars
            g.selectAll(".bar")
                .data(bins)
                .join("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.x0) + 1)
                .attr("width", d => Math.max(0, x(d.x1) - x(d.x0) - 1))
                .attr("y", d => y(d.length))
                .attr("height", d => chartHeight - y(d.length))
                .attr("fill", "#4682B4")
                .on("mouseover", function(event, d) {
                    d3.select(this).attr("opacity", 0.8);
                    tooltip.transition().duration(200).style("opacity", 0.9);
                    tooltip.html(`Range: ${d.x0.toFixed(1)} - ${d.x1.toFixed(1)} hours<br>Count: ${d.length}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this).attr("opacity", 1);
                    tooltip.transition().duration(500).style("opacity", 0);
                });
        }
        
        // Create Line Chart
        function createLineChart(data) {
            // Clear loading indicator
            d3.select("#line-chart-container").html("");
            
            const width = document.getElementById('line-chart-container').offsetWidth;
            const height = 400;
            const margin = { top: 30, right: 30, bottom: 50, left: 60 };
            
            // Filter data with valid processing times
            const validData = data.filter(d => d["Total Processing Time"] && !isNaN(d["Total Processing Time"]));
            
            // Sort data by date
            validData.sort((a, b) => a["Routed Date Time"] - b["Routed Date Time"]);
            
            // Group by date (day)
            const groupedData = d3.rollup(
                validData,
                v => d3.mean(v, d => d["Total Processing Time"]),
                d => d["Routed Date Time"].toDateString()
            );
            
            const lineData = Array.from(groupedData, ([date, avgTime]) => {
                return { date: new Date(date), avgTime };
            });
            
            // Create SVG
            const svg = d3.select("#line-chart-container").append("svg")
                .attr("width", width)
                .attr("height", height);
            
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            const g = svg.append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);
            
            // X scale
            const x = d3.scaleTime()
                .domain(d3.extent(lineData, d => d.date))
                .range([0, chartWidth]);
            
            // Y scale
            const y = d3.scaleLinear()
                .domain([0, d3.max(lineData, d => d.avgTime) || 10])
                .nice()
                .range([chartHeight, 0]);
            
            // Add X axis
            g.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(0, ${chartHeight})`)
                .call(d3.axisBottom(x).tickFormat(d3.timeFormat("%m/%d")));
            
            // Add X axis label
            g.append("text")
                .attr("class", "axis-title")
                .attr("x", chartWidth / 2)
                .attr("y", chartHeight + 35)
                .attr("text-anchor", "middle")
                .text("Date");
            
            // Add Y axis
            g.append("g")
                .attr("class", "axis")
                .call(d3.axisLeft(y));
            
            // Y axis label
            g.append("text")
                .attr("class", "axis-title")
                .attr("transform", "rotate(-90)")
                .attr("y", -45)
                .attr("x", -chartHeight / 2)
                .attr("text-anchor", "middle")
                .text("Average Processing Time (Hours)");
            
            // Create line
            const line = d3.line()
                .x(d => x(d.date))
                .y(d => y(d.avgTime))
                .curve(d3.curveMonotoneX);
            
            // Add line path
            g.append("path")
                .datum(lineData)
                .attr("fill", "none")
                .attr("stroke", "#1E90FF")
                .attr("stroke-width", 2)
                .attr("d", line);
            
            // Add dots
            g.selectAll(".dot")
                .data(lineData)
                .join("circle")
                .attr("class", "dot")
                .attr("cx", d => x(d.date))
                .attr("cy", d => y(d.avgTime))
                .attr("r", 4)
                .attr("fill", "#1E90FF")
                .on("mouseover", function(event, d) {
                    d3.select(this).attr("r", 6);
                    tooltip.transition().duration(200).style("opacity", 0.9);
                    tooltip.html(`Date: ${d.date.toLocaleDateString()}<br>Avg. Time: ${d.avgTime.toFixed(2)} hours`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this).attr("r", 4);
                    tooltip.transition().duration(500).style("opacity", 0);
                });
        }
